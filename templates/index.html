<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT 账号管理面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        .truncate-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="app()" x-init="init()">
    <!-- 登录页面 -->
    <div x-show="!token" x-cloak class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h1 class="text-2xl font-bold text-center mb-6">ChatGPT 账号管理</h1>
            <form @submit.prevent="login">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">用户名</label>
                    <input type="text" x-model="loginForm.username" class="w-full border rounded px-3 py-2" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">密码</label>
                    <input type="password" x-model="loginForm.password" class="w-full border rounded px-3 py-2" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">登录</button>
                <p x-show="loginError" class="text-red-500 text-sm mt-2" x-text="loginError"></p>
            </form>
        </div>
    </div>

    <!-- 主界面 -->
    <div x-show="token" x-cloak>
        <!-- 顶部导航 -->
        <nav class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800">ChatGPT 账号管理面板</h1>
                <div class="flex items-center gap-4">
                    <span class="text-gray-600" x-text="currentUser?.username"></span>
                    <button @click="logout" class="text-red-500 hover:text-red-700">退出</button>
                </div>
            </div>
        </nav>

        <!-- 统计卡片 -->
        <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:bg-gray-50" @click="applyCardFilter('total')">
                        <div class="text-sm text-gray-500">总账号</div>
                        <div class="text-2xl font-bold" x-text="stats.total || 0"></div>
                    </div>
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:bg-gray-50" @click="applyCardFilter('pending')">
                    <div class="text-sm text-gray-500">待绑卡</div>
                    <div class="text-2xl font-bold text-yellow-500" x-text="stats.pending || 0"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:bg-gray-50" @click="applyCardFilter('sync')">
                    <div class="text-sm text-gray-500">已同步</div>
                    <div class="text-2xl font-bold text-blue-500" x-text="stats.cliproxy_synced || 0"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:bg-gray-50" @click="applyCardFilter('banned')">
                    <div class="text-sm text-gray-500">已封禁</div>
                    <div class="text-2xl font-bold text-rose-500" x-text="stats.banned || 0"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:bg-gray-50" @click="applyCardFilter('failed')">
                    <div class="text-sm text-gray-500">失败</div>
                    <div class="text-2xl font-bold text-red-500" x-text="stats.failed || 0"></div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 cursor-pointer hover:bg-gray-50" @click="applyCardFilter('expired')">
                    <div class="text-sm text-gray-500">已过期</div>
                    <div class="text-2xl font-bold text-gray-500" x-text="stats.expired || 0"></div>
                </div>
                </div>

            <!-- 快捷操作 -->
            <div class="bg-white rounded-lg shadow p-4 mb-6 flex flex-wrap items-center gap-3">
                <button @click="openImportModal" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">导入账号</button>
                <button @click="exportSelectedToFile" :disabled="selectedIds.length === 0 || exporting" class="bg-teal-500 text-white px-3 py-1 rounded hover:bg-teal-600 disabled:opacity-50">
                    <i class="fas" :class="exporting ? 'fa-spinner fa-spin' : 'fa-download'"></i>
                    <span x-text="exporting ? '导出中...' : `导出选中 (${selectedIds.length})`"></span>
                </button>
                <button @click="openInviteModal" class="bg-sky-500 text-white px-3 py-1 rounded hover:bg-sky-600">邀请码管理</button>
                <button @click="openRedemptionModal" class="bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600">兑换码管理</button>
                <button @click="openSystemConfigModal" class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">系统设置</button>
                <button @click="refreshAllSubscriptions" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600" :disabled="refreshingSubscriptions">
                    <i class="fas" :class="refreshingSubscriptions ? 'fa-spinner fa-spin' : 'fa-crown'"></i>
                    <span x-text="refreshingSubscriptions ? '刷新中...' : '刷新订阅状态'"></span>
                </button>
                <a href="/join" target="_blank" class="bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">自动加入页</a>
            </div>

            <!-- 筛选栏 -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <input type="text" x-model="filter.search" @input.debounce.300ms="loadAccounts" placeholder="搜索邮箱..." class="border rounded px-3 py-2">
                    <select x-model="filter.status" @change="loadAccounts" class="border rounded px-3 py-2">
                        <option value="">全部状态</option>
                        <option value="pending">待绑卡</option>
                        <option value="active">已激活</option>
                        <option value="bound">绑卡成功</option>
                        <option value="banned">被封禁</option>
                        <option value="rate_limited">限流</option>
                        <option value="failed">失败</option>
                        <option value="expired">已过期</option>
                    </select>
                    <select x-model="filter.has_rt" @change="loadAccounts" class="border rounded px-3 py-2">
                        <option value="">RT状态</option>
                        <option value="yes">有RT</option>
                        <option value="no">无RT</option>
                    </select>
                    <input type="date" x-model="filter.date_from" @change="loadAccounts" class="border rounded px-3 py-2">
                    <input type="date" x-model="filter.date_to" @change="loadAccounts" class="border rounded px-3 py-2">
                    <button @click="resetFilter" class="bg-gray-200 hover:bg-gray-300 rounded px-3 py-2">重置</button>
                </div>
            </div>

            <!-- 批量操作 -->
            <div x-show="selectedIds.length > 0" class="bg-blue-50 rounded-lg p-4 mb-4 flex items-center gap-4">
                <span>已选择 <span x-text="selectedIds.length"></span> 项</span>
                <button @click="batchUpdateStatus('active')" class="bg-green-500 text-white px-3 py-1 rounded">标记激活</button>
                <button @click="batchUpdateStatus('failed')" class="bg-red-500 text-white px-3 py-1 rounded">标记失败</button>
                <button @click="batchDelete" class="bg-red-600 text-white px-3 py-1 rounded">批量删除</button>
            </div>

            <!-- 账号表格 -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3"><input type="checkbox" @change="toggleSelectAll" :checked="isAllSelected"></th>
                            <th class="px-4 py-3 text-left">序号</th>
                            <th class="px-4 py-3 text-left">邮箱</th>
                            <th class="px-4 py-3 text-left">订阅状态</th>
                            <th class="px-4 py-3 text-left">封禁</th>
                            <th class="px-4 py-3 text-left">降级</th>
                            <th class="px-4 py-3 text-left">RT</th>
                            <th class="px-4 py-3 text-left">绑卡链接</th>
                            <th class="px-4 py-3 text-left">已同步</th>
                            <th class="px-4 py-3 text-left">注册时间</th>
                            <th class="px-4 py-3 text-left">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="(account, index) in accounts" :key="account.id">
                            <tr class="border-t hover:bg-gray-50">
                                <td class="px-4 py-3"><input type="checkbox" :value="account.id" x-model="selectedIds"></td>
                                <td class="px-4 py-3 text-sm text-gray-500" x-text="(pagination.page - 1) * pagination.page_size + index + 1"></td>
                                <td class="px-4 py-3 truncate-cell" :title="account.email">
                                    <span class="cursor-pointer" @click="copyText(account.email)" x-text="account.email"></span>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex gap-1">
                                        <span x-show="account.is_plus" class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">Plus</span>
                                        <span x-show="account.is_team" class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-700">Team</span>
                                        <span x-show="!account.is_plus && !account.is_team" class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800" x-text="subscriptionText(account.subscription_status)"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <span x-show="account.status === 'banned'" class="text-red-500"><i class="fas fa-ban"></i></span>
                                    <span x-show="account.status !== 'banned'" class="text-gray-300"><i class="fas fa-minus"></i></span>
                                </td>
                                <td class="px-4 py-3">
                                    <span x-show="account.is_demoted" class="text-orange-500" :title="`降级时间: ${formatDate(account.demoted_at)}`"><i class="fas fa-arrow-down"></i></span>
                                    <span x-show="!account.is_demoted" class="text-gray-300"><i class="fas fa-minus"></i></span>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex gap-1">
                                        <!-- Plus RT 状态 -->
                                        <span x-show="account.plus_refresh_token" class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">Plus✓</span>
                                        <span x-show="!account.plus_refresh_token && (account.plus_bound || account.is_plus)" class="px-2 py-1 text-xs rounded bg-blue-50 text-blue-400">Plus✗</span>
                                        <!-- Team RT 状态 -->
                                        <span x-show="account.team_refresh_token" class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-700">Team✓</span>
                                        <span x-show="!account.team_refresh_token && (account.team_bound || account.is_team)" class="px-2 py-1 text-xs rounded bg-purple-50 text-purple-400">Team✗</span>
                                        <!-- 无任何 RT -->
                                        <span x-show="!account.refresh_token && !account.plus_refresh_token && !account.team_refresh_token && !account.plus_bound && !account.team_bound && !account.is_plus && !account.is_team" class="text-gray-300">-</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="flex gap-1">
                                        <!-- Plus 状态 -->
                                        <span x-show="account.plus_bound" class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">Plus✓</span>
                                        <button x-show="!account.plus_bound && account.checkout_url" @click="openExternal(account.checkout_url)" class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600" title="Plus绑卡">Plus</button>
                                        <!-- Team 状态 -->
                                        <span x-show="account.team_bound" class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-700">Team✓</span>
                                        <button x-show="!account.team_bound && account.team_checkout_url" @click="openExternal(account.team_checkout_url)" class="px-2 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600" title="Team绑卡">Team</button>
                                        <!-- 无链接 -->
                                        <span x-show="!account.checkout_url && !account.team_checkout_url && !account.plus_bound && !account.team_bound" class="text-gray-300">-</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <span x-show="account.cliproxy_synced" class="text-green-500"><i class="fas fa-check"></i></span>
                                    <span x-show="!account.cliproxy_synced" class="text-gray-300"><i class="fas fa-times"></i></span>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-500" x-text="formatDate(account.registered_at)"></td>
                                <td class="px-4 py-3">
                                    <div class="flex gap-2">
                                        <button @click="openOAuth(account)" class="text-blue-500 hover:text-blue-700" title="OAuth授权">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button @click="refreshToken(account)" class="text-green-500 hover:text-green-700" title="刷新Token" x-show="account.refresh_token">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button @click="syncCliproxyAccount(account)" class="text-indigo-500 hover:text-indigo-700" :class="((!account.refresh_token && !account.plus_refresh_token && !account.team_refresh_token) || account.syncing) ? 'opacity-50 pointer-events-none' : ''" title="同步到 CLIProxyAPI">
                                            <i class="fas" :class="account.syncing ? 'fa-spinner fa-spin' : 'fa-cloud-arrow-up'"></i>
                                        </button>
                                        <button @click="refreshSubscription(account)" class="text-orange-500 hover:text-orange-700" title="刷新订阅状态" x-show="account.access_token || account.plus_access_token || account.team_access_token">
                                            <i class="fas fa-crown"></i>
                                        </button>
                                        <button @click="viewAccount(account)" class="text-gray-500 hover:text-gray-700" title="查看详情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button @click="deleteAccount(account.id)" class="text-red-500 hover:text-red-700" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>

                <!-- 分页 -->
                <div class="bg-gray-50 px-4 py-3 flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        共 <span x-text="pagination.total"></span> 条，第 <span x-text="pagination.page"></span>/<span x-text="pagination.total_pages"></span> 页
                    </div>
                    <div class="flex gap-2 items-center">
                        <button @click="prevPage" :disabled="pagination.page <= 1" class="px-3 py-1 border rounded disabled:opacity-50">上一页</button>
                        <div class="flex items-center gap-1">
                            <span class="text-sm text-gray-500">跳转</span>
                            <input type="number" x-model.number="jumpPage" min="1" :max="pagination.total_pages" @keydown.enter="goToPage(jumpPage)" class="w-16 px-2 py-1 border rounded text-center text-sm" placeholder="#">
                            <button @click="goToPage(jumpPage)" class="px-2 py-1 border rounded text-sm hover:bg-gray-100">GO</button>
                        </div>
                        <button @click="nextPage" :disabled="pagination.page >= pagination.total_pages" class="px-3 py-1 border rounded disabled:opacity-50">下一页</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详情弹窗 -->
    <div x-show="showModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showModal=false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] overflow-auto">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">账号详情</h3>
                <button @click="showModal=false" class="text-gray-500 hover:text-gray-700">&times;</button>
            </div>
            <div class="p-4 space-y-4" x-show="currentAccount">
                <div><strong>邮箱:</strong> <span x-text="currentAccount?.email"></span></div>
                <div><strong>密码:</strong> <span x-text="currentAccount?.password"></span> <button @click="copyText(currentAccount?.password)" class="text-blue-500 text-sm">复制</button></div>
                <div><strong>账号状态:</strong> <span x-text="statusText(currentAccount?.status)"></span></div>
                <div><strong>订阅状态:</strong> <span x-text="subscriptionText(currentAccount?.subscription_status)"></span></div>
                <div><strong>是否封禁:</strong> <span x-text="currentAccount?.status === 'banned' ? '是' : '否'"></span></div>
                <div><strong>是否降级:</strong>
                    <span x-text="currentAccount?.is_demoted ? '是' : '否'" :class="currentAccount?.is_demoted ? 'text-orange-600' : ''"></span>
                    <span x-show="currentAccount?.is_demoted && currentAccount?.demoted_at" class="text-sm text-gray-500" x-text="' (降级时间: ' + formatDate(currentAccount?.demoted_at) + ')'"></span>
                </div>
                <div><strong>已同步到 CLIProxyAPI:</strong> <span x-text="currentAccount?.cliproxy_synced ? '是' : '否'"></span></div>
                <div><strong>Account ID:</strong> <span x-text="currentAccount?.account_id || '-'"></span></div>
                <!-- 主 Token（默认/兼容） -->
                <div x-show="currentAccount?.access_token" class="border-l-4 border-gray-300 pl-3">
                    <strong>主 Access Token:</strong>
                    <div class="mt-1 p-2 bg-gray-100 rounded text-xs break-all max-h-20 overflow-auto" x-text="currentAccount?.access_token?.substring(0,200)+'...'"></div>
                    <button @click="copyText(currentAccount?.access_token)" class="text-blue-500 text-sm">复制完整Token</button>
                </div>
                <div x-show="currentAccount?.refresh_token" class="border-l-4 border-gray-300 pl-3">
                    <strong>主 Refresh Token:</strong>
                    <div class="mt-1 p-2 bg-gray-100 rounded text-xs break-all" x-text="currentAccount?.refresh_token"></div>
                    <button @click="copyText(currentAccount?.refresh_token)" class="text-blue-500 text-sm">复制</button>
                </div>

                <!-- Plus Token -->
                <div x-show="currentAccount?.plus_access_token || currentAccount?.plus_refresh_token" class="mt-4 pt-4 border-t border-blue-200">
                    <div class="text-blue-600 font-bold mb-2"><i class="fas fa-star"></i> Plus 账户 Token</div>
                    <div x-show="currentAccount?.plus_access_token" class="border-l-4 border-blue-400 pl-3 mb-2">
                        <strong>Plus Access Token:</strong>
                        <div class="mt-1 p-2 bg-blue-50 rounded text-xs break-all max-h-20 overflow-auto" x-text="currentAccount?.plus_access_token?.substring(0,200)+'...'"></div>
                        <button @click="copyText(currentAccount?.plus_access_token)" class="text-blue-500 text-sm">复制完整Token</button>
                    </div>
                    <div x-show="currentAccount?.plus_refresh_token" class="border-l-4 border-blue-400 pl-3">
                        <strong>Plus Refresh Token:</strong>
                        <div class="mt-1 p-2 bg-blue-50 rounded text-xs break-all" x-text="currentAccount?.plus_refresh_token"></div>
                        <button @click="copyText(currentAccount?.plus_refresh_token)" class="text-blue-500 text-sm">复制</button>
                    </div>
                </div>

                <!-- Team Token -->
                <div x-show="currentAccount?.team_access_token || currentAccount?.team_refresh_token" class="mt-4 pt-4 border-t border-purple-200">
                    <div class="text-purple-600 font-bold mb-2"><i class="fas fa-users"></i> Team 账户 Token</div>
                    <div x-show="currentAccount?.team_access_token" class="border-l-4 border-purple-400 pl-3 mb-2">
                        <strong>Team Access Token:</strong>
                        <div class="mt-1 p-2 bg-purple-50 rounded text-xs break-all max-h-20 overflow-auto" x-text="currentAccount?.team_access_token?.substring(0,200)+'...'"></div>
                        <button @click="copyText(currentAccount?.team_access_token)" class="text-purple-500 text-sm">复制完整Token</button>
                    </div>
                    <div x-show="currentAccount?.team_refresh_token" class="border-l-4 border-purple-400 pl-3">
                        <strong>Team Refresh Token:</strong>
                        <div class="mt-1 p-2 bg-purple-50 rounded text-xs break-all" x-text="currentAccount?.team_refresh_token"></div>
                        <button @click="copyText(currentAccount?.team_refresh_token)" class="text-purple-500 text-sm">复制</button>
                    </div>
                </div>

                <!-- 绑卡链接 -->
                <div x-show="currentAccount?.checkout_url" class="mt-4 pt-4 border-t">
                    <strong>Plus 绑卡链接:</strong>
                    <a :href="currentAccount?.checkout_url" target="_blank" class="text-blue-500 hover:underline break-all" x-text="currentAccount?.checkout_url"></a>
                </div>
                <div x-show="currentAccount?.team_checkout_url">
                    <strong>Team 绑卡链接:</strong>
                    <a :href="currentAccount?.team_checkout_url" target="_blank" class="text-purple-500 hover:underline break-all" x-text="currentAccount?.team_checkout_url"></a>
                </div>
                <div><strong>注册时间:</strong> <span x-text="formatDate(currentAccount?.registered_at)"></span></div>
            </div>
        </div>
    </div>

    <!-- 导入弹窗 -->
    <div x-show="showImportModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showImportModal=false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-xl">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">导入账号</h3>
                <button @click="showImportModal=false" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-4 space-y-4">
                <div class="space-y-2">
                    <label class="block font-medium text-gray-700">选择文件</label>
                    <input type="file" accept=".json,.txt" x-ref="importFile" @change="importData.file = $event.target.files[0]" class="w-full border rounded px-3 py-2">
                    <p class="text-sm text-gray-500">支持 JSON 数组 / JSON Lines / 单条 JSON，字段与 chatgpt_accounts_api.json 一致即可。</p>
                </div>

                <div x-show="importData.message" :class="importData.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="p-3 rounded text-sm">
                    <span x-text="importData.message"></span>
                </div>

                <pre x-show="importData.details" class="bg-gray-100 text-xs p-3 rounded whitespace-pre-wrap" x-text="importData.details"></pre>

                <div class="flex justify-end gap-2">
                    <button @click="showImportModal=false" class="px-4 py-2 border rounded hover:bg-gray-50">取消</button>
                    <button @click="importAccounts" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50" :disabled="importData.importing || !importData.file">
                        <span x-show="!importData.importing">开始导入</span>
                        <span x-show="importData.importing"><i class="fas fa-spinner fa-spin"></i> 导入中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 邀请码管理弹窗 -->
    <div x-show="showInviteModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showInviteModal=false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-auto">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">邀请码管理</h3>
                <button @click="showInviteModal=false" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-4 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <input type="text" x-model="inviteForm.code" placeholder="邀请码(可选)" class="border rounded px-3 py-2">
                    <input type="number" min="0" x-model="inviteForm.max_uses" placeholder="可用次数(0不限)" class="border rounded px-3 py-2">
                    <input type="datetime-local" x-model="inviteForm.expires_at" class="border rounded px-3 py-2">
                    <button @click="createInviteCode" class="bg-sky-500 text-white px-3 py-2 rounded hover:bg-sky-600" :disabled="inviteSaving">
                        <span x-show="!inviteSaving">创建邀请码</span>
                        <span x-show="inviteSaving"><i class="fas fa-spinner fa-spin"></i> 创建中...</span>
                    </button>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <span>过期时间为本地时间，提交时自动转为 UTC。</span>
                    <span>邀请码首次使用时自动绑定一个可用 Team。</span>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="inviteForm.disabled">
                        <span>禁用</span>
                    </label>
                </div>

                <div x-show="inviteMessage" :class="inviteSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="p-3 rounded text-sm">
                    <span x-text="inviteMessage"></span>
                </div>

                <div class="flex justify-between items-center">
                    <h4 class="font-semibold">邀请码列表</h4>
                    <button @click="loadInviteCodes" class="text-sm text-blue-600 hover:text-blue-800">刷新</button>
                </div>

                <div class="border rounded overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left">邀请码</th>
                                <th class="px-3 py-2 text-left">账号ID</th>
                                <th class="px-3 py-2 text-left">使用</th>
                                <th class="px-3 py-2 text-left">状态</th>
                                <th class="px-3 py-2 text-left">过期时间</th>
                                <th class="px-3 py-2 text-left">最近使用</th>
                                <th class="px-3 py-2 text-left">创建时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="code in inviteCodes" :key="code.id">
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="px-3 py-2">
                                        <button class="text-blue-600 hover:text-blue-800" @click="copyText(code.code)" x-text="code.code"></button>
                                    </td>
                                    <td class="px-3 py-2" x-text="code.account_id || '-'"></td>
                                    <td class="px-3 py-2">
                                        <span x-text="code.max_uses ? `${code.used_count}/${code.max_uses}` : `${code.used_count}/不限`"></span>
                                    </td>
                                    <td class="px-3 py-2">
                                        <span x-show="!code.disabled" class="text-green-600">启用</span>
                                        <span x-show="code.disabled" class="text-gray-500">禁用</span>
                                    </td>
                                    <td class="px-3 py-2" x-text="formatDate(code.expires_at)"></td>
                                    <td class="px-3 py-2" x-text="formatDate(code.last_used_at)"></td>
                                    <td class="px-3 py-2" x-text="formatDate(code.created_at)"></td>
                                </tr>
                            </template>
                            <tr x-show="inviteCodes.length === 0">
                                <td colspan="7" class="px-3 py-6 text-center text-gray-500">暂无邀请码</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统配置模态框 -->
    <div x-show="showSystemConfigModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showSystemConfigModal=false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-auto">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">系统设置</h3>
                <button @click="showSystemConfigModal=false" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-8">
                <!-- Linux DO OAuth 配置 -->
                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <h4 class="text-md font-semibold mb-4 text-gray-800">Linux DO OAuth 配置</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client ID</label>
                            <input type="text" x-model="systemConfig.linuxdo_oauth.client_id"
                                   :placeholder="systemConfig.linuxdo_oauth.client_id_stored ? '已保存（不修改请留空）' : '请输入 Client ID'"
                                   class="w-full border rounded px-3 py-2">
                            <p x-show="systemConfig.linuxdo_oauth.client_id_stored" class="text-xs text-green-600 mt-1">
                                ✓ 已在数据库中保存
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Secret</label>
                            <div class="relative">
                                <input :type="systemConfig.linuxdo_oauth.show_secret ? 'text' : 'password'"
                                       x-model="systemConfig.linuxdo_oauth.client_secret"
                                       :placeholder="systemConfig.linuxdo_oauth.secret_stored ? '已保存（不修改请留空）' : '请输入 Client Secret'"
                                       class="w-full border rounded px-3 py-2 pr-10">
                                <button @click="systemConfig.linuxdo_oauth.show_secret = !systemConfig.linuxdo_oauth.show_secret"
                                        class="absolute right-2 top-2 text-gray-500 hover:text-gray-700"
                                        type="button">
                                    <i :class="systemConfig.linuxdo_oauth.show_secret ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                </button>
                            </div>
                            <p x-show="systemConfig.linuxdo_oauth.secret_stored" class="text-xs text-green-600 mt-1">
                                ✓ 已在数据库中保存
                            </p>
                        </div>
                        <button @click="saveLinuxDoOAuthConfig"
                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                :disabled="systemConfig.saving">
                            <span x-show="!systemConfig.saving">保存 OAuth 配置</span>
                            <span x-show="systemConfig.saving"><i class="fas fa-spinner fa-spin"></i> 保存中...</span>
                        </button>
                    </div>
                </div>

                <!-- Linux DO Credit 配置 -->
                <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                    <h4 class="text-md font-semibold mb-4 text-gray-800">Linux DO Credit 支付配置</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">商户 PID</label>
                            <input type="text" x-model="systemConfig.linuxdo_credit.pid"
                                   :placeholder="systemConfig.linuxdo_credit.pid_stored ? '已保存（不修改请留空）' : '请输入 PID'"
                                   class="w-full border rounded px-3 py-2">
                            <p x-show="systemConfig.linuxdo_credit.pid_stored" class="text-xs text-green-600 mt-1">
                                ✓ 已在数据库中保存
                            </p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">支付密钥 (KEY)</label>
                            <div class="relative">
                                <input :type="systemConfig.linuxdo_credit.show_key ? 'text' : 'password'"
                                       x-model="systemConfig.linuxdo_credit.key"
                                       :placeholder="systemConfig.linuxdo_credit.key_stored ? '已保存（不修改请留空）' : '请输入 KEY'"
                                       class="w-full border rounded px-3 py-2 pr-10">
                                <button @click="systemConfig.linuxdo_credit.show_key = !systemConfig.linuxdo_credit.show_key"
                                        class="absolute right-2 top-2 text-gray-500 hover:text-gray-700"
                                        type="button">
                                    <i :class="systemConfig.linuxdo_credit.show_key ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                </button>
                            </div>
                            <p x-show="systemConfig.linuxdo_credit.key_stored" class="text-xs text-green-600 mt-1">
                                ✓ 已在数据库中保存
                            </p>
                        </div>
                        <button @click="saveLinuxDoCreditConfig"
                                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                :disabled="systemConfig.saving">
                            <span x-show="!systemConfig.saving">保存 Credit 配置</span>
                            <span x-show="systemConfig.saving"><i class="fas fa-spinner fa-spin"></i> 保存中...</span>
                        </button>
                    </div>
                </div>

                <!-- 保存反馈消息 -->
                <div x-show="systemConfig.message" class="p-3 rounded"
                     :class="systemConfig.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                    <p x-text="systemConfig.message"></p>
                </div>

                <div class="text-sm text-gray-500 border-t pt-4 mt-4">
                    <p><strong>提示：</strong></p>
                    <ul class="list-disc pl-5 space-y-1 mt-2">
                        <li>数据库配置优先级高于环境变量</li>
                        <li>留空表示不修改当前配置</li>
                        <li>敏感字段（Secret、KEY）不显示完整内容，仅提示是否已保存</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- OAuth 授权模态框 -->
    <div x-show="showOAuthModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showOAuthModal=false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-xl">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">Codex OAuth 授权</h3>
                <button @click="showOAuthModal=false" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-4 space-y-4">
                <div class="space-y-2">
                    <label class="block font-medium text-gray-700">当前邮箱</label>
                    <div class="flex gap-2">
                        <input type="text" readonly :value="oauthData.email || ''" class="flex-1 border rounded px-3 py-2 bg-gray-50 text-sm" />
                        <button @click="copyText(oauthData.email || '')" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" title="复制邮箱" :disabled="!oauthData.email">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- 步骤 1: 授权链接 -->
                <div class="space-y-2">
                    <label class="block font-medium text-gray-700">步骤 1: 打开授权链接</label>
                    <div class="flex gap-2">
                        <input type="text" readonly :value="oauthData.authUrl" class="flex-1 border rounded px-3 py-2 bg-gray-50 text-sm" />
                        <button @click="copyText(oauthData.authUrl)" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300" title="复制链接">
                            <i class="fas fa-copy"></i>
                        </button>
                        <a :href="oauthData.authUrl" target="_blank" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" title="在新标签页打开">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </div>

                <!-- 步骤 2: 粘贴回调 URL -->
                <div class="space-y-2">
                    <label class="block font-medium text-gray-700">步骤 2: 登录后，复制浏览器地址栏的完整 URL</label>
                    <p class="text-sm text-gray-500">登录完成后，浏览器会跳转到类似 <code class="bg-gray-100 px-1 rounded">http://localhost:1455/auth/callback?code=xxx&state=xxx</code> 的页面，请复制整个地址栏内容</p>
                    <textarea x-model="oauthData.callbackUrl" placeholder="粘贴完整的回调 URL..." class="w-full border rounded px-3 py-2 h-24 text-sm" :disabled="oauthData.submitting"></textarea>
                </div>

                <!-- 状态显示 -->
                <div x-show="oauthData.message" :class="oauthData.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="p-3 rounded text-sm">
                    <span x-text="oauthData.message"></span>
                </div>

                <!-- 提交按钮 -->
                <div class="flex justify-end gap-2">
                    <a :href="`https://mail.chatgpt.org.uk/${oauthData.email || ''}`" target="_blank" class="px-4 py-2 border rounded hover:bg-gray-50" :class="!oauthData.email ? 'pointer-events-none opacity-50' : ''">查看邮箱</a>
                    <button @click="showOAuthModal=false" class="px-4 py-2 border rounded hover:bg-gray-50">取消</button>
                    <button @click="submitOAuthCallback" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50" :disabled="oauthData.submitting || !oauthData.callbackUrl">
                        <span x-show="!oauthData.submitting">提交回调</span>
                        <span x-show="oauthData.submitting"><i class="fas fa-spinner fa-spin"></i> 处理中...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 兑换码管理弹窗 -->
    <div x-show="showRedemptionModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showRedemptionModal=false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-auto">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold">兑换码管理</h3>
                <button @click="showRedemptionModal=false" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-4 space-y-6">
                <!-- 批量创建表单 -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-gray-800">批量创建兑换码</h4>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <input type="number" min="1" max="100" x-model="redemptionForm.count" placeholder="数量 (1-100)" class="border rounded px-3 py-2">
                        <select x-model="redemptionForm.channel" class="border rounded px-3 py-2">
                            <option value="common">通用</option>
                            <option value="linux-do">Linux DO</option>
                            <option value="xhs">小红书</option>
                            <option value="xianyu">闲鱼</option>
                        </select>
                        <select x-model="redemptionForm.order_type" class="border rounded px-3 py-2">
                            <option value="warranty">质保订单</option>
                            <option value="no-warranty">无质保订单</option>
                        </select>
                        <input type="number" x-model="redemptionForm.account_id" placeholder="绑定账号ID (可选)" class="border rounded px-3 py-2">
                        <button @click="batchCreateRedemptionCodes" class="bg-orange-500 text-white px-3 py-2 rounded hover:bg-orange-600" :disabled="redemptionSaving">
                            <span x-show="!redemptionSaving">创建兑换码</span>
                            <span x-show="redemptionSaving"><i class="fas fa-spinner fa-spin"></i> 创建中...</span>
                        </button>
                    </div>

                    <!-- 状态消息 -->
                    <div x-show="redemptionMessage" :class="redemptionSuccess ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'" class="mt-3 p-3 rounded text-sm">
                        <span x-text="redemptionMessage"></span>
                    </div>
                </div>

                <!-- 筛选栏 -->
                <div class="flex gap-2 items-center">
                    <select x-model="redemptionFilter.channel" @change="loadRedemptionCodes" class="border rounded px-3 py-2">
                        <option value="">全部渠道</option>
                        <option value="common">通用</option>
                        <option value="linux-do">Linux DO</option>
                        <option value="xhs">小红书</option>
                        <option value="xianyu">闲鱼</option>
                    </select>
                    <select x-model="redemptionFilter.is_redeemed" @change="loadRedemptionCodes" class="border rounded px-3 py-2">
                        <option value="">全部状态</option>
                        <option value="false">未兑换</option>
                        <option value="true">已兑换</option>
                    </select>
                    <button @click="loadRedemptionCodes" class="text-sm text-blue-600 hover:text-blue-800 ml-auto">刷新</button>
                </div>

                <!-- 兑换码列表 -->
                <div class="border rounded overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">ID</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">兑换码</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">渠道</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">订单类型</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">状态</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">兑换者</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">账号邮箱</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">兑换时间</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">创建时间</th>
                                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="code in redemptionCodes" :key="code.id">
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="px-3 py-2 text-sm" x-text="code.id"></td>
                                    <td class="px-3 py-2 text-sm">
                                        <button class="text-blue-600 hover:text-blue-800 font-mono" @click="copyText(code.code)" x-text="code.code"></button>
                                    </td>
                                    <td class="px-3 py-2 text-sm" x-text="code.channel_name || code.channel"></td>
                                    <td class="px-3 py-2 text-sm">
                                        <span x-text="code.order_type === 'warranty' ? '质保' : '无质保'" :class="code.order_type === 'warranty' ? 'text-green-600' : 'text-orange-600'"></span>
                                    </td>
                                    <td class="px-3 py-2 text-sm">
                                        <span x-show="code.is_redeemed" class="text-green-600"><i class="fas fa-check-circle"></i> 已兑换</span>
                                        <span x-show="!code.is_redeemed" class="text-gray-500"><i class="far fa-circle"></i> 未兑换</span>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-600" x-text="code.redeemed_by || '-'"></td>
                                    <td class="px-3 py-2 text-sm text-gray-600" x-text="code.account_email || '-'"></td>
                                    <td class="px-3 py-2 text-sm text-gray-500" x-text="code.redeemed_at ? formatDate(code.redeemed_at) : '-'"></td>
                                    <td class="px-3 py-2 text-sm text-gray-500" x-text="formatDate(code.created_at)"></td>
                                    <td class="px-3 py-2">
                                        <button @click="deleteRedemptionCode(code.id)" class="text-red-500 hover:text-red-700" title="删除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="redemptionCodes.length === 0">
                                <td colspan="10" class="px-3 py-6 text-center text-gray-500">暂无兑换码</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">
                        共 <span x-text="redemptionPagination.total"></span> 条，第 <span x-text="redemptionPagination.page"></span>/<span x-text="redemptionPagination.total_pages"></span> 页
                    </div>
                    <div class="flex gap-2">
                        <button @click="prevRedemptionPage" :disabled="redemptionPagination.page <= 1" class="px-3 py-1 border rounded disabled:opacity-50">上一页</button>
                        <button @click="nextRedemptionPage" :disabled="redemptionPagination.page >= redemptionPagination.total_pages" class="px-3 py-1 border rounded disabled:opacity-50">下一页</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                token: localStorage.getItem('token'),
                currentUser: null,
                loginForm: { username: '', password: '' },
                loginError: '',
                accounts: [],
                stats: {},
                filter: { search: '', status: '', has_rt: '', cliproxy_synced: '', pending: '', date_from: '', date_to: '', page: 1, page_size: 20 },
                pagination: { total: 0, page: 1, page_size: 20, total_pages: 0 },
                selectedIds: [],
                showModal: false,
                currentAccount: null,
                showImportModal: false,
                importData: {
                    file: null,
                    importing: false,
                    message: '',
                    success: false,
                    details: ''
                },
                showOAuthModal: false,
                oauthData: {
                    accountId: null,
                    email: '',
                    authUrl: '',
                    state: '',
                    callbackUrl: '',
                    submitting: false,
                    message: '',
                    success: false
                },
                showInviteModal: false,
                inviteCodes: [],
                inviteSaving: false,
                inviteMessage: '',
                inviteSuccess: false,
                inviteForm: { code: '', max_uses: '', expires_at: '', disabled: false },
                showSystemConfigModal: false,
                systemConfig: {
                    linuxdo_oauth: {
                        client_id: '',
                        client_secret: '',
                        client_id_stored: false,
                        secret_stored: false,
                        show_secret: false
                    },
                    linuxdo_credit: {
                        pid: '',
                        key: '',
                        pid_stored: false,
                        key_stored: false,
                        show_key: false
                    },
                    saving: false,
                    message: '',
                    success: false
                },
                showRedemptionModal: false,
                redemptionCodes: [],
                redemptionSaving: false,
                redemptionMessage: '',
                redemptionSuccess: false,
                redemptionForm: {
                    count: 10,
                    channel: 'common',
                    order_type: 'warranty',
                    account_id: null
                },
                redemptionFilter: {
                    channel: '',
                    is_redeemed: '',
                    page: 1,
                    page_size: 20
                },
                redemptionPagination: {
                    total: 0,
                    page: 1,
                    page_size: 20,
                    total_pages: 0
                },
                refreshingSubscriptions: false,
                jumpPage: 1,
                exporting: false,

                async init() {
                    if (this.token) {
                        await this.loadCurrentUser();
                        await this.loadStats();
                        await this.loadAccounts();
                    }
                    // 监听 OAuth 回调消息
                    window.addEventListener('message', (event) => {
                        if (event.data?.type === 'oauth_success') {
                            this.loadAccounts();
                            this.loadStats();
                            alert('OAuth 授权成功！');
                        } else if (event.data?.type === 'oauth_error') {
                            alert('OAuth 授权失败: ' + (event.data.error || '未知错误'));
                        }
                    });
                },

                async login() {
                    try {
                        const res = await fetch('/api/v1/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });
                        const data = await res.json();
                        if (res.ok) {
                            this.token = data.token;
                            this.currentUser = data.user;
                            localStorage.setItem('token', data.token);
                            this.loginError = '';
                            await this.init();
                        } else {
                            this.loginError = data.error || '登录失败';
                        }
                    } catch (e) {
                        this.loginError = '网络错误';
                    }
                },

                logout() {
                    this.token = null;
                    this.currentUser = null;
                    localStorage.removeItem('token');
                },

                async api(url, options = {}) {
                    options.headers = { ...options.headers, 'Authorization': `Bearer ${this.token}` };
                    const res = await fetch(url, options);
                    if (res.status === 401) { this.logout(); return null; }
                    const text = await res.text();
                    if (!text) {
                        return res.ok ? {} : { error: `HTTP ${res.status}` };
                    }
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        const snippet = text.length > 300 ? text.slice(0, 300) + '...' : text;
                        return { error: snippet || `HTTP ${res.status}` };
                    }
                },

                async loadCurrentUser() {
                    this.currentUser = await this.api('/api/v1/auth/me');
                },

                async loadStats() {
                    this.stats = await this.api('/api/v1/accounts/stats') || {};
                },

                async loadAccounts() {
                    const params = new URLSearchParams(this.filter);
                    const data = await this.api('/api/v1/accounts?' + params);
                    if (data) {
                        this.accounts = data.data || [];
                        this.pagination = { total: data.total, page: data.page, page_size: data.page_size, total_pages: data.total_pages };
                    }
                },

                applyCardFilter(type) {
                    this.filter.page = 1;
                    this.filter.search = '';
                    this.filter.date_from = '';
                    this.filter.date_to = '';
                    this.filter.has_rt = '';
                    this.filter.status = '';
                    this.filter.cliproxy_synced = '';
                    this.filter.pending = '';
                    if (type === 'pending') {
                        this.filter.pending = 'yes';
                    } else if (type === 'sync') {
                        this.filter.cliproxy_synced = 'yes';
                    } else if (type === 'banned') {
                        this.filter.status = 'banned';
                    } else if (type === 'failed') {
                        this.filter.status = 'failed';
                    } else if (type === 'expired') {
                        this.filter.status = 'expired';
                    }
                    this.loadAccounts();
                },

                resetFilter() {
                    this.filter = { search: '', status: '', has_rt: '', cliproxy_synced: '', pending: '', date_from: '', date_to: '', page: 1, page_size: 20 };
                    this.loadAccounts();
                },

                prevPage() { if (this.filter.page > 1) { this.filter.page--; this.loadAccounts(); } },
                nextPage() { if (this.filter.page < this.pagination.total_pages) { this.filter.page++; this.loadAccounts(); } },
                goToPage(page) {
                    page = parseInt(page);
                    if (isNaN(page) || page < 1 || page > this.pagination.total_pages) return;
                    this.filter.page = page;
                    this.loadAccounts();
                },

                get isAllSelected() { return this.accounts.length > 0 && this.selectedIds.length === this.accounts.length; },
                toggleSelectAll(e) { this.selectedIds = e.target.checked ? this.accounts.map(a => a.id) : []; },

                async deleteAccount(id) {
                    if (!confirm('确定删除?')) return;
                    await this.api(`/api/v1/accounts/${id}`, { method: 'DELETE' });
                    this.loadAccounts();
                    this.loadStats();
                },

                async batchDelete() {
                    if (!confirm(`确定删除 ${this.selectedIds.length} 个账号?`)) return;
                    await this.api('/api/v1/accounts/batch-delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: this.selectedIds })
                    });
                    this.selectedIds = [];
                    this.loadAccounts();
                    this.loadStats();
                },

                async batchUpdateStatus(status) {
                    await this.api('/api/v1/accounts/batch-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids: this.selectedIds, status })
                    });
                    this.selectedIds = [];
                    this.loadAccounts();
                    this.loadStats();
                },

                async exportSelectedToFile() {
                    if (this.selectedIds.length === 0) return;
                    this.exporting = true;
                    try {
                        // 获取选中的账号数据
                        const selectedAccounts = this.accounts.filter(a => this.selectedIds.includes(a.id));
                        const lines = [];
                        const now = new Date().toISOString();

                        for (const acc of selectedAccounts) {
                            // Plus RT
                            if (acc.plus_refresh_token) {
                                lines.push(JSON.stringify({
                                    id_token: '',
                                    access_token: acc.plus_access_token || '',
                                    refresh_token: acc.plus_refresh_token,
                                    account_id: acc.account_id || '',
                                    last_refresh: now,
                                    email: acc.email,
                                    type: 'plus',
                                    expired: false
                                }));
                            }
                            // Team RT
                            if (acc.team_refresh_token) {
                                lines.push(JSON.stringify({
                                    id_token: '',
                                    access_token: acc.team_access_token || '',
                                    refresh_token: acc.team_refresh_token,
                                    account_id: acc.account_id || '',
                                    last_refresh: now,
                                    email: acc.email,
                                    type: 'team',
                                    expired: false
                                }));
                            }
                            // 如果只有旧的 refresh_token
                            if (!acc.plus_refresh_token && !acc.team_refresh_token && acc.refresh_token) {
                                lines.push(JSON.stringify({
                                    id_token: '',
                                    access_token: acc.access_token || '',
                                    refresh_token: acc.refresh_token,
                                    account_id: acc.account_id || '',
                                    last_refresh: now,
                                    email: acc.email,
                                    type: acc.is_team ? 'team' : (acc.is_plus ? 'plus' : 'free'),
                                    expired: false
                                }));
                            }
                        }

                        if (lines.length === 0) {
                            alert('选中的账号没有可导出的 Refresh Token');
                            return;
                        }

                        // 生成文件并下载
                        const content = lines.join('\n');
                        const blob = new Blob([content], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        const timestamp = new Date().toISOString().replace(/[:\-T]/g, '').slice(0, 14);
                        a.href = url;
                        a.download = `export_cliproxy_${timestamp}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } finally {
                        this.exporting = false;
                    }
                },

                viewAccount(account) { this.currentAccount = account; this.showModal = true; },

                openImportModal() {
                    this.importData = { file: null, importing: false, message: '', success: false, details: '' };
                    this.showImportModal = true;
                    if (this.$refs.importFile) { this.$refs.importFile.value = ''; }
                },

                openInviteModal() {
                    this.showInviteModal = true;
                    this.inviteMessage = '';
                    this.inviteSuccess = false;
                    this.inviteForm = { code: '', max_uses: '', expires_at: '', disabled: false };
                    this.loadInviteCodes();
                },

                async loadInviteCodes() {
                    const res = await this.api('/api/v1/invite-codes');
                    this.inviteCodes = res?.data || [];
                },

                async createInviteCode() {
                    const payload = {};
                    if (this.inviteForm.code) {
                        payload.code = this.inviteForm.code.trim();
                    }
                    if (this.inviteForm.max_uses !== '') {
                        payload.max_uses = Number(this.inviteForm.max_uses || 0);
                    }
                    if (this.inviteForm.expires_at) {
                        payload.expires_at = this.toRFC3339(this.inviteForm.expires_at);
                    }
                    payload.disabled = !!this.inviteForm.disabled;

                    this.inviteSaving = true;
                    this.inviteMessage = '';
                    try {
                        const res = await this.api('/api/v1/invite-codes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!res) return;
                        if (res.error) {
                            this.inviteMessage = res.error || '创建失败';
                            this.inviteSuccess = false;
                            return;
                        }
                        this.inviteMessage = `创建成功：${res.code || payload.code || ''}`;
                        this.inviteSuccess = true;
                        this.inviteForm.code = '';
                        this.inviteForm.max_uses = '';
                        this.inviteForm.expires_at = '';
                        this.inviteForm.disabled = false;
                        await this.loadInviteCodes();
                    } finally {
                        this.inviteSaving = false;
                    }
                },

                // 系统配置管理
                async openSystemConfigModal() {
                    this.showSystemConfigModal = true;
                    this.systemConfig.message = '';
                    this.systemConfig.success = false;
                    await this.loadSystemConfig();
                },

                async loadSystemConfig() {
                    try {
                        const [oauthRes, creditRes] = await Promise.all([
                            this.api('/api/v1/admin/config/linuxdo-oauth'),
                            this.api('/api/v1/admin/config/linuxdo-credit')
                        ]);

                        if (oauthRes?.success) {
                            this.systemConfig.linuxdo_oauth = {
                                ...this.systemConfig.linuxdo_oauth,
                                client_id: oauthRes.data.client_id || '',
                                client_id_stored: oauthRes.data.client_id_stored || false,
                                secret_stored: oauthRes.data.secret_stored || false,
                                client_secret: ''
                            };
                        }

                        if (creditRes?.success) {
                            this.systemConfig.linuxdo_credit = {
                                ...this.systemConfig.linuxdo_credit,
                                pid: creditRes.data.pid || '',
                                pid_stored: creditRes.data.pid_stored || false,
                                key_stored: creditRes.data.key_stored || false,
                                key: ''
                            };
                        }
                    } catch (e) {
                        console.error('Load system config failed:', e);
                    }
                },

                async saveLinuxDoOAuthConfig() {
                    this.systemConfig.saving = true;
                    this.systemConfig.message = '';
                    try {
                        const payload = {};
                        if (this.systemConfig.linuxdo_oauth.client_id) {
                            payload.client_id = this.systemConfig.linuxdo_oauth.client_id.trim();
                        }
                        if (this.systemConfig.linuxdo_oauth.client_secret) {
                            payload.client_secret = this.systemConfig.linuxdo_oauth.client_secret.trim();
                        }

                        const res = await this.api('/api/v1/admin/config/linuxdo-oauth', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (res?.success) {
                            this.systemConfig.message = 'Linux DO OAuth 配置保存成功';
                            this.systemConfig.success = true;
                            this.systemConfig.linuxdo_oauth.client_secret = '';
                            await this.loadSystemConfig();
                        } else {
                            this.systemConfig.message = res?.message || '保存失败';
                            this.systemConfig.success = false;
                        }
                    } catch (e) {
                        this.systemConfig.message = '保存失败: ' + e.message;
                        this.systemConfig.success = false;
                    } finally {
                        this.systemConfig.saving = false;
                    }
                },

                async saveLinuxDoCreditConfig() {
                    this.systemConfig.saving = true;
                    this.systemConfig.message = '';
                    try {
                        const payload = {};
                        if (this.systemConfig.linuxdo_credit.pid) {
                            payload.pid = this.systemConfig.linuxdo_credit.pid.trim();
                        }
                        if (this.systemConfig.linuxdo_credit.key) {
                            payload.key = this.systemConfig.linuxdo_credit.key.trim();
                        }

                        const res = await this.api('/api/v1/admin/config/linuxdo-credit', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (res?.success) {
                            this.systemConfig.message = 'Linux DO Credit 配置保存成功';
                            this.systemConfig.success = true;
                            this.systemConfig.linuxdo_credit.key = '';
                            await this.loadSystemConfig();
                        } else {
                            this.systemConfig.message = res?.message || '保存失败';
                            this.systemConfig.success = false;
                        }
                    } catch (e) {
                        this.systemConfig.message = '保存失败: ' + e.message;
                        this.systemConfig.success = false;
                    } finally {
                        this.systemConfig.saving = false;
                    }
                },

                // 兑换码管理
                async openRedemptionModal() {
                    this.showRedemptionModal = true;
                    this.redemptionMessage = '';
                    this.redemptionSuccess = false;
                    this.redemptionFilter.page = 1;
                    await this.loadRedemptionCodes();
                },

                async loadRedemptionCodes() {
                    const params = new URLSearchParams({
                        page: this.redemptionFilter.page,
                        page_size: this.redemptionFilter.page_size
                    });
                    if (this.redemptionFilter.channel) {
                        params.append('channel', this.redemptionFilter.channel);
                    }
                    if (this.redemptionFilter.is_redeemed) {
                        params.append('is_redeemed', this.redemptionFilter.is_redeemed);
                    }

                    const res = await this.api(`/api/v1/redemption-codes?${params}`);
                    if (res) {
                        this.redemptionCodes = res.data || [];
                        this.redemptionPagination = {
                            total: res.total || 0,
                            page: res.page || 1,
                            page_size: res.page_size || 20,
                            total_pages: res.total_pages || 0
                        };
                    }
                },

                async batchCreateRedemptionCodes() {
                    if (!this.redemptionForm.count || this.redemptionForm.count < 1 || this.redemptionForm.count > 100) {
                        this.redemptionMessage = '数量必须在 1-100 之间';
                        this.redemptionSuccess = false;
                        return;
                    }

                    this.redemptionSaving = true;
                    this.redemptionMessage = '';

                    try {
                        const payload = {
                            count: parseInt(this.redemptionForm.count),
                            channel: this.redemptionForm.channel,
                            order_type: this.redemptionForm.order_type
                        };
                        if (this.redemptionForm.account_id) {
                            payload.account_id = parseInt(this.redemptionForm.account_id);
                        }

                        const res = await this.api('/api/v1/redemption-codes/batch', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!res) return;

                        if (res.error) {
                            this.redemptionMessage = res.error;
                            this.redemptionSuccess = false;
                            return;
                        }

                        this.redemptionMessage = `${res.message || '创建成功'}，共创建 ${res.count || 0} 个兑换码`;
                        this.redemptionSuccess = true;
                        this.redemptionForm.count = 10;
                        await this.loadRedemptionCodes();
                    } finally {
                        this.redemptionSaving = false;
                    }
                },

                async deleteRedemptionCode(id) {
                    if (!confirm('确定要删除这个兑换码吗？')) return;

                    const res = await this.api(`/api/v1/redemption-codes/${id}`, {
                        method: 'DELETE'
                    });

                    if (res?.message) {
                        await this.loadRedemptionCodes();
                    }
                },

                async prevRedemptionPage() {
                    if (this.redemptionFilter.page > 1) {
                        this.redemptionFilter.page--;
                        await this.loadRedemptionCodes();
                    }
                },

                async nextRedemptionPage() {
                    if (this.redemptionFilter.page < this.redemptionPagination.total_pages) {
                        this.redemptionFilter.page++;
                        await this.loadRedemptionCodes();
                    }
                },

                async importAccounts() {
                    if (!this.importData.file) {
                        this.importData.success = false;
                        this.importData.message = '请选择要导入的文件';
                        return;
                    }

                    this.importData.importing = true;
                    this.importData.message = '';
                    this.importData.details = '';

                    try {
                        const text = await this.importData.file.text();
                        const res = await this.api('/api/v1/accounts/import', {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain' },
                            body: text
                        });
                        if (!res) return;

                        if (res.error) {
                            this.importData.success = false;
                            this.importData.message = res.error || '导入失败';
                            return;
                        }

                        const imported = typeof res.imported === 'number' ? res.imported : (res.id ? 1 : 0);
                        const failed = typeof res.failed === 'number' ? res.failed : (res.errors ? res.errors.length : 0);
                        this.importData.success = failed === 0;
                        this.importData.message = `导入完成：成功 ${imported}，失败 ${failed}`;
                        if (res.errors && res.errors.length) {
                            this.importData.details = res.errors.slice(0, 20).join('\n');
                        }

                        await this.loadAccounts();
                        await this.loadStats();
                    } catch (e) {
                        this.importData.success = false;
                        this.importData.message = '导入失败: ' + (e.message || '未知错误');
                    } finally {
                        this.importData.importing = false;
                    }
                },

                async syncCliproxyAccount(account) {
                    if (!account?.id) return;
                    if (!account.refresh_token && !account.plus_refresh_token && !account.team_refresh_token) {
                        alert('账号无可用 refresh_token，无法同步');
                        return;
                    }
                    account.syncing = true;
                    try {
                        const res = await this.api(`/api/v1/accounts/${account.id}/cliproxy-sync`, { method: 'POST' });
                        if (res?.error) {
                            alert('同步失败: ' + res.error);
                        } else {
                            // 成功时静默刷新，不弹窗
                            await this.loadAccounts();
                            await this.loadStats();
                        }
                    } catch (e) {
                        alert('同步失败: ' + e.message);
                    } finally {
                        account.syncing = false;
                    }
                },

                async openOAuth(account) {
                    // 重置 OAuth 数据
                    this.oauthData = {
                        accountId: account.id,
                        email: account.email || '',
                        authUrl: '',
                        state: '',
                        callbackUrl: '',
                        submitting: false,
                        message: '',
                        success: false
                    };

                    const res = await this.api('/api/v1/oauth/codex/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ account_id: account.id })
                    });
                    if (!res || res.error || !res.url) {
                        alert(res?.error || 'Failed to start OAuth flow');
                        return;
                    }

                    this.oauthData.authUrl = res.url;
                    this.oauthData.state = res.state;
                    this.showOAuthModal = true;
                },

                async submitOAuthCallback() {
                    if (!this.oauthData.callbackUrl || !this.oauthData.state) {
                        this.oauthData.message = '请粘贴回调 URL';
                        this.oauthData.success = false;
                        return;
                    }

                    this.oauthData.submitting = true;
                    this.oauthData.message = '';

                    try {
                        const res = await this.api('/api/v1/oauth/codex/callback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                callback_url: this.oauthData.callbackUrl,
                                state: this.oauthData.state
                            })
                        });

                        if (res && !res.error) {
                            this.oauthData.success = true;
                            this.oauthData.message = '授权成功！账号已更新。';
                            await this.loadAccounts();
                            await this.loadStats();
                            setTimeout(() => {
                                this.showOAuthModal = false;
                            }, 1500);
                        } else {
                            this.oauthData.success = false;
                            this.oauthData.message = res?.error || '授权失败';
                        }
                    } catch (e) {
                        this.oauthData.success = false;
                        this.oauthData.message = '请求失败: ' + e.message;
                    } finally {
                        this.oauthData.submitting = false;
                    }
                },


                async refreshToken(account) {
                    try {
                        const res = await this.api(`/api/v1/accounts/${account.id}/refresh`, { method: 'POST' });
                        if (res?.message) {
                            alert(res.message);
                            this.loadAccounts();
                        } else if (res?.error) {
                            alert('刷新失败: ' + res.error);
                        }
                    } catch (e) {
                        alert('刷新失败: ' + e.message);
                    }
                },

                async refreshSubscription(account) {
                    try {
                        const res = await this.api(`/api/v1/accounts/${account.id}/refresh-subscription`, { method: 'POST' });
                        if (res?.message) {
                            let msg = res.changed
                                ? `订阅状态已更新:\n• 状态: ${res.old_status || '未知'} → ${res.subscription_status}\n• Plus: ${res.old_is_plus ? '是' : '否'} → ${res.is_plus ? '是' : '否'}\n• Team: ${res.old_is_team ? '是' : '否'} → ${res.is_team ? '是' : '否'}`
                                : `订阅状态未变化:\n• 状态: ${res.subscription_status}\n• Plus: ${res.is_plus ? '是' : '否'}\n• Team: ${res.is_team ? '是' : '否'}`;
                            alert(msg);
                            this.loadAccounts();
                        } else if (res?.error) {
                            alert('刷新失败: ' + res.error);
                        }
                    } catch (e) {
                        alert('刷新失败: ' + e.message);
                    }
                },

                async refreshAllSubscriptions() {
                    if (this.refreshingSubscriptions) return;
                    this.refreshingSubscriptions = true;
                    try {
                        const res = await this.api('/api/v1/accounts/refresh-all-subscriptions', { method: 'POST' });
                        if (res?.message) {
                            alert(`${res.message}\n总计: ${res.total}, 更新: ${res.updated}\nPlus: ${res.plus_count}, Team: ${res.team_count}`);
                            this.loadAccounts();
                        } else if (res?.error) {
                            alert('刷新失败: ' + res.error);
                        }
                    } catch (e) {
                        alert('刷新失败: ' + e.message);
                    } finally {
                        this.refreshingSubscriptions = false;
                    }
                },

                openExternal(url) {
                    const target = (url || '').trim();
                    if (!target) {
                        return;
                    }
                    window.open(target, '_blank', 'noopener,noreferrer');
                },

                copyText(text) {
                    navigator.clipboard.writeText(text);
                },

                statusText(status) {
                    const map = { pending: '待绑卡', active: '已激活', bound: '绑卡成功', failed: '失败', expired: '已过期', banned: '被封禁', rate_limited: '限流' };
                    return map[status] || status;
                },

                subscriptionText(status) {
                    const value = (status || '').toLowerCase();
                    const map = { free: '免费', plus: 'Plus', team: 'Team', business: 'Business' };
                    return map[value] || (status || '-');
                },

                formatDate(date) {
                    if (!date) return '-';
                    return new Date(date).toLocaleString('zh-CN');
                },

                toRFC3339(value) {
                    if (!value) return '';
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) return value;
                    return date.toISOString();
                }
            }
        }
    </script>
</body>
</html>
