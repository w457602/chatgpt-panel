<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>兑换 ChatGPT Team 名额</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100">
    <div x-data="redeemApp()" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
            <!-- 头部 -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-8 text-center">
                <i class="fas fa-gift text-5xl mb-4"></i>
                <h1 class="text-3xl font-bold mb-2">兑换 ChatGPT Team 名额</h1>
                <p class="text-blue-100 text-sm">请填写以下信息完成兑换</p>
            </div>

            <!-- 表单内容 -->
            <div class="p-8">
                <!-- 渠道选择 -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-layer-group text-blue-500 mr-2"></i>兑换渠道
                    </label>
                    <select x-model="channel" @change="onChannelChange" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition">
                        <option value="common">通用渠道</option>
                        <option value="linux-do">Linux DO</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-2">
                        <span x-show="channel === 'common'">适用于通用兑换码</span>
                        <span x-show="channel === 'linux-do'">适用于 Linux DO 论坛用户</span>
                    </p>
                </div>

                <!-- 邮箱输入 -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-envelope text-blue-500 mr-2"></i>邮箱地址 <span class="text-red-500">*</span>
                    </label>
                    <input type="email" x-model="email" placeholder="name@example.com" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                           :class="{'border-red-300': errorField === 'email'}">
                    <p class="text-xs text-gray-500 mt-2">请输入你用来登录 ChatGPT 的邮箱</p>
                </div>

                <!-- 兑换码输入 -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-ticket-alt text-blue-500 mr-2"></i>兑换码 <span class="text-red-500">*</span>
                    </label>
                    <input type="text" x-model="code" @input="formatCode" placeholder="XXXX-XXXX-XXXX" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition font-mono tracking-wider"
                           :class="{'border-red-300': errorField === 'code'}"
                           maxlength="14">
                    <p class="text-xs text-gray-500 mt-2">格式：XXXX-XXXX-XXXX（自动转大写）</p>
                </div>

                <!-- Linux DO UID（条件显示） -->
                <div x-show="channel === 'linux-do'" x-transition class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fab fa-linux text-blue-500 mr-2"></i>Linux DO UID <span class="text-red-500">*</span>
                    </label>
                    <input type="text" x-model="redeemerUid" placeholder="12345" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                           :class="{'border-red-300': errorField === 'uid'}">
                    <p class="text-xs text-gray-500 mt-2">请输入你的 Linux DO 论坛 UID</p>
                </div>

                <!-- 错误提示 -->
                <div x-show="errorMessage" x-transition class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-circle text-red-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-semibold text-red-800 mb-1">兑换失败</p>
                            <p class="text-sm text-red-600" x-text="errorMessage"></p>
                        </div>
                    </div>
                </div>

                <!-- 成功提示 -->
                <div x-show="successMessage" x-transition class="mb-6 p-4 bg-green-50 border-l-4 border-green-500 rounded-r-lg">
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-3"></i>
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-green-800 mb-1">兑换成功！</p>
                            <p class="text-sm text-green-600" x-text="successMessage"></p>
                            <div x-show="accountEmail" class="mt-3 p-3 bg-white rounded-lg border border-green-200">
                                <p class="text-xs text-gray-600 mb-1">Team 账号邮箱</p>
                                <p class="text-sm font-mono text-gray-800" x-text="accountEmail"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 提交按钮 -->
                <button @click="handleRedeem" :disabled="loading" 
                        class="w-full py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg font-semibold text-lg shadow-lg hover:shadow-xl hover:from-blue-600 hover:to-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                    <span x-show="!loading" class="flex items-center justify-center">
                        <i class="fas fa-paper-plane mr-2"></i>
                        立即兑换
                    </span>
                    <span x-show="loading" class="flex items-center justify-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        兑换中，请稍候...
                    </span>
                </button>

                <!-- 提示信息 -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <p class="text-xs text-blue-800">
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>温馨提示：</strong>兑换成功后，ChatGPT 会向您的邮箱发送 Team 邀请邮件，请及时查收并完成加入。
                    </p>
                </div>
            </div>

            <!-- 页脚 -->
            <div class="bg-gray-50 px-8 py-4 text-center text-xs text-gray-500 border-t">
                <p>如有问题，请联系管理员</p>
            </div>
        </div>
    </div>

    <script>
        function redeemApp() {
            return {
                channel: 'common',
                email: '',
                code: '',
                redeemerUid: '',
                loading: false,
                errorMessage: '',
                successMessage: '',
                accountEmail: '',
                errorField: '',

                onChannelChange() {
                    this.errorMessage = '';
                    this.successMessage = '';
                    this.errorField = '';
                },

                formatCode() {
                    // 移除所有非字母数字字符并转大写
                    let formatted = this.code.toUpperCase().replace(/[^A-Z0-9]/g, '');

                    // 添加分隔符
                    if (formatted.length > 4 && formatted.length <= 8) {
                        formatted = `${formatted.slice(0, 4)}-${formatted.slice(4)}`;
                    } else if (formatted.length > 8) {
                        formatted = `${formatted.slice(0, 4)}-${formatted.slice(4, 8)}-${formatted.slice(8, 12)}`;
                    }

                    // 限制最大长度（12个字符 + 2个分隔符 = 14）
                    this.code = formatted.slice(0, 14);
                },

                validateForm() {
                    this.errorMessage = '';
                    this.errorField = '';

                    // 验证邮箱
                    if (!this.email.trim()) {
                        this.errorMessage = '请输入邮箱地址';
                        this.errorField = 'email';
                        return false;
                    }

                    // 简单的邮箱格式验证
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(this.email.trim())) {
                        this.errorMessage = '请输入有效的邮箱地址';
                        this.errorField = 'email';
                        return false;
                    }

                    // 验证兑换码
                    if (!this.code.trim()) {
                        this.errorMessage = '请输入兑换码';
                        this.errorField = 'code';
                        return false;
                    }

                    // 验证兑换码格式
                    const codeRegex = /^[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
                    if (!codeRegex.test(this.code.trim())) {
                        this.errorMessage = '兑换码格式不正确，应为 XXXX-XXXX-XXXX 格式';
                        this.errorField = 'code';
                        return false;
                    }

                    // Linux DO 渠道需要验证 UID
                    if (this.channel === 'linux-do' && !this.redeemerUid.trim()) {
                        this.errorMessage = 'Linux DO 渠道需要填写论坛 UID';
                        this.errorField = 'uid';
                        return false;
                    }

                    return true;
                },

                async handleRedeem() {
                    // 验证表单
                    if (!this.validateForm()) {
                        return;
                    }

                    this.loading = true;
                    this.errorMessage = '';
                    this.successMessage = '';
                    this.accountEmail = '';

                    try {
                        const payload = {
                            email: this.email.trim(),
                            code: this.code.trim(),
                            channel: this.channel
                        };

                        // Linux DO 渠道需要传递 redeemer_uid
                        if (this.channel === 'linux-do') {
                            payload.redeemer_uid = this.redeemerUid.trim();
                        }

                        const response = await fetch('/api/v1/redemption/redeem', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            // 处理各种错误情况
                            if (response.status === 400) {
                                this.errorMessage = data.error || data.message || '请求参数错误，请检查输入';
                            } else if (response.status === 404) {
                                this.errorMessage = '兑换码不存在或已失效';
                            } else if (response.status === 503) {
                                this.errorMessage = '暂无可用账号，请稍后再试或联系管理员';
                            } else {
                                this.errorMessage = data.error || data.message || '兑换失败，请稍后重试';
                            }
                            return;
                        }

                        // 兑换成功
                        this.successMessage = '兑换成功！邀请邮件已发送到您的邮箱，请查收并完成加入。';
                        this.accountEmail = data.account_email || '';

                        // 清空表单
                        this.email = '';
                        this.code = '';
                        this.redeemerUid = '';

                        // 3秒后自动清除成功消息
                        setTimeout(() => {
                            this.successMessage = '';
                            this.accountEmail = '';
                        }, 10000);

                    } catch (error) {
                        console.error('兑换请求失败:', error);
                        this.errorMessage = '网络错误，请检查网络连接后重试';
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    </script>

